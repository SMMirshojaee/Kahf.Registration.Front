<div>هزینه ها:</div>
<div class="grid align-center">
    @for (cost of costsToEdit; track $index) {
    <div class="col">
        <p-floatlabel variant="on" class="mt-2">
            <input [disabled]="costInputsDisable" class="w-full" pInputText id="cost_{{cost.id}}" autocomplete="off"
                [(ngModel)]="cost.amount" (input)="convertToEnglishDigits($event)" />
            <label for="cost_{{cost.id}}">{{cost.title}}</label>
        </p-floatlabel>
        {{cost.amount|toman}} تومن
    </div>
    }
    @if(costsToEdit?.length){
    <p-button (onClick)="costInputsDisable=!costInputsDisable">
        @if(costInputsDisable){
        اعمال تغییر
        }@else(){
        لغو
        }
    </p-button>
    @if(!costInputsDisable){
    <p-button class="pr-2" severity="danger" (onClick)="openChangeCostsModal($event)">ثبت</p-button>

    }
    }
</div>
<div>
    جمع هزینه ها: {{totalCost|number}} ریال معادل {{totalCost|toman}} تومن
</div>
<p-divider></p-divider>
<p-table #dt1 [value]="applicants" dataKey="id" [size]="'small'" styleClass="text-sm  filter-div"
    [globalFilterFields]="['firstName', 'lastName', 'nationalNumber', 'phoneNumber']" sortMode="multiple"
    [stripedRows]="true">
    <ng-template #caption>
        <div class="flex">
            <p-iconfield iconPosition="right" class="w-full">
                <p-inputicon>
                    <i class="pi pi-search"></i>
                </p-inputicon>
                <input pInputText [(ngModel)]="searchValue" type="text" class="w-5"
                    (input)="dt1.filterGlobal($event.target['value'], 'contains')"
                    placeholder="سرچ: نام - نام خانوادگی - کدملی - موبایل " />
                @if(searchValue){
                <i class="pi pi-filter-slash pr-2 cursor-pointer" (click)="clear()"></i>
                }
            </p-iconfield>
            <i style="font-size: xx-large;padding-left:5px" class="cursor-pointer pi pi-sync text-pink-500"
                (click)="ngOnInit()"></i>
            <i style="font-size: xx-large;" class="pi pi-file-excel text-primary cursor-pointer float-left"
                (click)="exportToExcel(dt1)"></i>
        </div>
    </ng-template>
    <ng-template #header>
        <tr>
            <th>ردیف</th>
            <th pSortableColumn="stepTitle">مرحله<p-sortIcon field="stepTitle" /></th>
            <th pSortableColumn="statusTitle">وضعیت<p-sortIcon field="statusTitle" /></th>
            <th pSortableColumn="id">Id<p-sortIcon field="id" /></th>
            <!-- <th pSortableColumn="firstName">نام<p-sortIcon field="firstName" /></th> -->
            <th pSortableColumn="fullName">نام و نام خانوادگی <p-sortIcon field="fullName" /></th>
            <th pSortableColumn="nationalNumber">کدملی <p-sortIcon field="nationalNumber" /></th>
            <!-- <th pSortableColumn="phoneNumber">شماره موبایل <p-sortIcon field="phoneNumber" /></th> -->
            <th pSortableColumn="membersCount">تعداد همراه <p-sortIcon field="membersCount" /></th>
            <th pSortableColumn="totalExtraCosts">هزینه های اضافی (تومن) <p-sortIcon field="totalExtraCosts" /></th>
            <th pSortableColumn="totalCost">هزینه کل (تومن) <p-sortIcon field="totalCost" /></th>
            <th pSortableColumn="remained">مانده (تومن)<p-sortIcon field="remained" /></th>
            <th pSortableColumn="totalCash">واریز نقدی (تومن)<p-sortIcon field="totalCash" /></th>
            <th pSortableColumn="totalLoan">وام (تومن)<p-sortIcon field="totalLoan" /></th>
            <th pSortableColumn="totalInstallments">اقساط پرداخت شده (تومن)<p-sortIcon field="totalInstallments" /></th>
            <th pSortableColumn="remainedLoan">مانده اقساط (تومن)<p-sortIcon field="remainedLoan" /></th>
        </tr>
        <tr>
            <th></th>
            <th><p-columnFilter matchMode="contains" type="text" field="stepTitle"></p-columnFilter></th>
            <th><p-columnFilter matchMode="contains" type="text" field="statusTitle"></p-columnFilter></th>
            <th></th>
            <th><p-columnFilter matchMode="contains" type="text" field="fullName"></p-columnFilter></th>
            <!-- <th><p-columnFilter matchMode="contains" type="text" field="lastName"></p-columnFilter></th> -->
            <th><p-columnFilter matchMode="contains" type="text" field="nationalNumber"></p-columnFilter></th>
            <!-- <th></th> -->
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template #body let-applicant let-index="rowIndex">
        <tr>
            <td>{{index+1}}</td>
            <td>{{applicant.stepTitle}}</td>
            <td>{{applicant.statusTitle}}</td>
            <td>{{applicant.id}}</td>
            <td>{{applicant.fullName}}</td>
            <!-- <td>{{applicant.lastName}}</td> -->
            <td>{{applicant.nationalNumber}}
                <i (click)="openSigninModal($event, applicant)"
                    class="cursor-pointer text-cyan-500 pi pi-external-link pr-2"></i>
            </td>
            <!-- <td>{{applicant.phoneNumber}}</td> -->
            <td>{{applicant.membersCount}}</td>
            <td>
                {{applicant.totalExtraCosts|toman}}
                <i (click)="openExtraCostsModal(applicant)"
                    class="cursor-pointer text-cyan-500 pi pi-plus-circle pr-2"></i>
            </td>
            <td>{{applicant.totalCost|toman}}</td>
            <td>
                @if(applicant.remained>0){
                <span class="text-red-500"> ({{applicant.remained|toman}})</span>
                }@else {
                <span class="text-green-500"> {{applicant.remained|toman}}</span>
                }
            </td>
            <td>{{applicant.totalCash|toman}}</td>
            <td>
                {{applicant.totalLoan|toman}}
                @if(applicant.totalLoan){
                <i (click)="openInstallmentsModal(applicant)"
                    class="cursor-pointer text-cyan-500 pi pi-plus-circle pr-2"></i>
                }
            </td>
            <td><span class="text-green-500">{{applicant.totalInstallments|toman}}</span></td>
            <td><span class="text-orange-500">{{applicant.remainedLoan|toman}}</span> </td>
        </tr>
    </ng-template>
    <ng-template #emptymessage>
        <tr>
            <td colspan="10">دیتایی جهت نمایش وجود ندارد</td>
        </tr>
    </ng-template>
</p-table>
<p-confirmPopup key="costChangeConfirmation"></p-confirmPopup>
<p-confirmpopup />
<p-dialog key="extraCostsDialog" [(visible)]="showExtraCostsModal" dismissableMask="true" modal="true"
    header="هزینه های اضافی">
    <p-table [value]="extraCosts">
        <ng-template #header>
            <tr>
                <th>عنوان</th>
                <th>مبلغ</th>
                <th>توضیحات</th>
                <th></th>
            </tr>
        </ng-template>
        <ng-template #body let-extraCost let-index="rowIndex">
            <tr>
                <td>{{extraCost.title}}</td>
                <td>{{extraCost.amount|toman}}</td>
                <td>{{extraCost.description}}</td>
                <td>
                    <i (click)="openRemoveExtraCostConfirmationDialog($event,index)"
                        class="cursor-pointer text-red-500 pi pi-trash pr-2"></i>
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-dialog>

<p-dialog key="installmentsDialog" [(visible)]="showInstallmentsModal" dismissableMask="true" modal="true"
    header="اقساط" [style]="{ width: '70%' }">
    @if(newInstallmentFormGroup){

    <form [formGroup]="newInstallmentFormGroup">
        <div class="grid align-center">
            <div class="col">
                <p-floatlabel variant="on" class="mt-2">
                    <input id="newAmount" class="w-full" pInputText autocomplete="off" formControlName="amount" />
                    <label for="newAmount">مبلغ</label>
                </p-floatlabel>
            </div>
            <div class="col">
                <p-floatlabel variant="on" class="mt-2">
                    <ng-persian-datepicker (dateOnSelect)="dateChanged($event)" uiInitViewMode="day"
                        [dateInitValue]="false" [uiTodayBtnEnable]="true">
                        <input placeholder="تاریخ" class="w-full" pInputText id="date" formControlName="date"
                            [autocomplete]="false" />
                    </ng-persian-datepicker>
                    <!-- {{newInstallmentFormGroup.controls['date'].value}} -->
                </p-floatlabel>
            </div>
            <div class="col">
                <p-floatlabel variant="on" class="mt-2">
                    <input id="newAmount" class="w-full" pInputText autocomplete="off" formControlName="description" />
                    <label for="newAmount">توضیحات</label>
                </p-floatlabel>
            </div>
            <div class="col-auto">
                <p-button label="ثبت" [size]="'small'" (onClick)="submitNewInstallment()" />
            </div>
        </div>
        <div>
            {{newInstallmentFormGroup.controls['amount'].value|toman:true}}
        </div>
    </form>
    }

    <p-table [value]="installments">
        <ng-template #header>
            <tr>
                <th>تاریخ</th>
                <th>مبلغ (تومن)</th>
                <th>توضیحات</th>
                <th>حذف</th>
            </tr>
        </ng-template>
        <ng-template #body let-installment let-index="rowIndex">
            <tr>
                <td>{{installment.verifyDate|persianDate:true}}</td>
                <td>{{installment.amount|toman}}</td>
                <td>{{installment.description}}</td>
                <td>
                    @if(!installment.authority){
                    <i class="pi pi-trash text-red-500 cursor-pointer"
                        (click)="removeInstallment(installment.id,index,$event)"></i>
                    }@else {
                    اقساط آنلاین امکان حذف ندارند
                    }
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-dialog>